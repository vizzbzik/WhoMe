<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"><title> WhoMe ‚Ä¢ –ß–∞—Ç—ã</title>
<link rel="icon" href="/placeholder.png">
<style>
:root{--blue:#4a76a8;--bg:#eef1f5;--card:#fff;--muted:#7b8ca4}
*{box-sizing:border-box}body{margin:0;background:var(--bg);font-family:Arial,Helvetica,sans-serif}
.top{background:var(--blue);color:#fff;padding:12px 16px;display:flex;gap:16px;align-items:center}
.top a{color:#fff;text-decoration:none;margin-right:10px}
.wrap{max-width:980px;margin:0 auto;padding:16px}
.columns{display:flex;gap:12px}
.left{width:320px}
.card{background:var(--card);border-radius:12px;padding:12px;margin:12px 0}
.row{display:flex;gap:8px;align-items:center}
.ava{width:40px;height:40px;border-radius:50%;object-fit:cover;background:#ddd}
.chatrow{display:flex;gap:8px;padding:8px;border-radius:10px;cursor:pointer}
.chatrow:hover{background:#f0f4ff}
.msgs{height:420px;overflow:auto;background:#fff;border-radius:10px;padding:10px;border:1px solid #e5e9f2}
.msg{max-width:70%;margin:6px 0;padding:8px 10px;border-radius:14px;background:#f1f5ff}
.me{margin-left:auto;background:#e1f3d8}
.gift{display:inline-block;padding:6px 8px;border-radius:10px;background:#fff}
.muted{color:#7b8ca4;font-size:12px}
select,input,button{padding:10px;border:1px solid #cfd6e4;border-radius:8px}
button{background:var(--blue);color:#fff;border:none;cursor:pointer}
</style>
</head>
<body>
<div class="top">
  <a href="/">–õ–µ–Ω—Ç–∞</a>
  <a href="/chats">–ß–∞—Ç—ã</a>
  <a href="/profile">–ü—Ä–æ—Ñ–∏–ª—å</a>
  <div style="margin-left:auto" id="who"></div>
</div>

<div class="wrap">
  <div class="columns">
    <div class="left">
      <div class="card">
        <h3>–ù–æ–≤—ã–π —á–∞—Ç</h3>
        <div class="row"><input id="with_user" placeholder="@username"><button onclick="startChat()">–ù–∞—á–∞—Ç—å</button></div>
      </div>
      <div class="card">
        <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Ç—ã:</h3>
        <div id="chatList"></div>
      </div>
    </div>



    <div class="card" style="flex:1">
      <div class="row">
        <img class="ava" id="peerAva" src="/placeholder.png">
        <div>
          <div id="peerName" style="font-weight:bold"></div>
          <div id="peerUser" class="muted"></div>
        </div>
      </div>
      <div class="msgs" id="msgs"></div>
      <div class="row" style="margin-top:8px">
        <input id="msgText" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" style="flex:1">
        <button onclick="sendText()">Send a message...</button>
        <select id="giftSelect"></select>
        <button onclick="sendGift()">üéÅ</button>
      </div>
    </div>
  </div>
</div>

<script>
let token = localStorage.getItem("token")||""; let user_id = localStorage.getItem("user_id")||"";
let currentChat = null; let peer = null; // {username, full_name, avatar}

who.textContent = token || "–≥–æ—Å—Ç—å";

async function loadGifts(){
  const r = await fetch("/gifts"); const gs = await r.json();
  giftSelect.innerHTML = gs.map(g=>`<option value="${g.id}">${g.name}</option>`).join("");
}
async function startChat(){
  if(!token) return alert("–í–æ–π–¥–∏—Ç–µ");
  const fd = new FormData(); fd.append("token", token); fd.append("with_username", with_user.value.trim());
  const r = await fetch("/chats/start",{method:"POST",body:fd}); const j = await r.json();
  loadChats().then(()=>openChat(j.chat_id));
}
async function loadChats(){
  const r = await fetch(`/chats/list?token=${encodeURIComponent(token)}`);
  const list = await r.json();
  chatList.innerHTML = list.map(c=>`
    <div class="chatrow" onclick="openChat(${c.id});"
         data-username="${c.username}" data-full="${c.full_name}" data-avatar="${c.avatar||'/placeholder.png'}">
      <img class="ava" src="${c.avatar||'/placeholder.png'}">
      <div><div><b>${c.full_name}</b> <span class="muted">${c.username}</span></div>
      <div class="muted">${c.last_gift? 'üéÅ –ü–æ–¥–∞—Ä–æ–∫' : (c.last_text||'')}</div></div>
    </div>`).join("");
}
async function openChat(chat_id){
  currentChat = chat_id;
  // –∏–Ω—Ñ–æ –∏–∑ DOM
  const node = [...document.querySelectorAll('.chatrow')].find(n=>+n.getAttribute('onclick').match(/\d+/)[0]===chat_id);
  if(node){
    peer = { username: node.dataset.username, full_name: node.dataset.full, avatar: node.dataset.avatar };
    peerAva.src = peer.avatar; peerName.textContent = peer.full_name; peerUser.textContent = peer.username;
  }
  const r = await fetch(`/chats/${chat_id}/messages?token=${encodeURIComponent(token)}`);
  const msgs = await r.json();
  msgsDiv.innerHTML = "";
  msgsDiv.scrollTop = msgsDiv.scrollHeight;
  renderMsgs(msgs);
}
function bubble(m){
  const me = (m.username===token);
  if(m.type==="gift"){
    return `<div class="msg ${me?'me':''}"><div class="gift"><img src="${m.gift_url}" style="height:56px"></div>
            <div class="muted">${new Date(m.created_at).toLocaleTimeString()}</div></div>`;
  }
  return `<div class="msg ${me?'me':''}">${m.text}<div class="muted">${new Date(m.created_at).toLocaleTimeString()}</div></div>`;
}
function renderMsgs(msgs){ msgsDiv.innerHTML = msgs.map(bubble).join(""); msgsDiv.scrollTop = msgsDiv.scrollHeight; }
async function sendText(){
  if(!currentChat) return;
  const fd = new FormData(); fd.append("token", token); fd.append("text", msgText.value);
  await fetch(`/chats/${currentChat}/send_text`, {method:"POST", body: fd});
  msgText.value=""; openChat(currentChat);
}
async function sendGift(){
  if(!currentChat) return;
  const fd = new FormData(); fd.append("token", token); fd.append("gift_id", giftSelect.value);
  await fetch(`/chats/${currentChat}/send_gift`, {method:"POST", body: fd});
  openChat(currentChat);
}
loadGifts(); loadChats();
</script>
</body>
</html>